version: '3.8'

services:
  moodle:
    image: moodlehq/moodleapp:4.4.0
    ports:
      - "8100:443"
    volumes:
      - moodledata:/bitnami/moodle

  nginx:
    image: nginx:latest
    container_name: nginxtest
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certbot/conf:/etc/letsencrypt/
      - ./certbot/www:/var/www/certbot/
    ports:
      - "80:80"
      - "443:443"

  certbot:
    image: certbot
    container_name: certbottest
    volumes:
      - ./certbot/www:/var/www/certbot/
      - ./certbot/conf:/etc/letsencrypt/
    command: >
      sh -c "
      echo '* * 25 * * certbot renew --nginx --noninteractive --post-hook \"nginx -s reload\"' > /etc/crontabs/root &&
      crond -f
      "

  tgbot:
    build:
      context: ./bot
    restart: always
    environment:
      - ${TELEGRAM_BOT_TOKEN}
      - ${WEATHER_API_KEY}
      
  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
    restart: always
    
volumes:
  moodledata:
  grafana-data: